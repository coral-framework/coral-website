<%

def summarize(text)
  truncate(doc_plain(text), :length => 50)
end

index = {}

# Modules
module_list = []
doc.modules.each do |module_name,m|
  type_list = []
  m.types.each do |t|
    type_info = {kind: t.kind, name: t.name, desc: summarize(t.doc_caption)}
    type_info['members'] = [].tap do |list|
      t.members.each do |mem|
        list << {kind: mem.kind, name: mem.name, desc: summarize(mem.doc_caption)}
      end
    end if t.members
    type_list << type_info
  end
  module_list << {name: module_name, types: type_list}
end
index['modules'] = module_list

# Pages
page_list = []
pages = sitemap.resources.select do |p|
  p.ext == '.html' and not p.path.match(/reference\/modules/)
end
pages.each do |page|
  page_info = {name: page.data.title, url: page.url}
  page_info['sections'] = [].tap do |list|
    page.data.sections.each{|i| list << {name: i[0], id: i[1]} }
  end if page.data.sections
  page_list << page_info
end
index['pages'] = page_list

%><%= index.to_json %>